# Upgrade guide

This document describes the notable breaking changes, if any, in each version of
the TypeScript client. See [CHANGELOG.md](./CHANGELOG.md) for a comprehensive
list of changes.

## v0.10

v0.10 is a complete rewrite of the TypeScript client. The new client is
automatically generated by [Stainless](https://www.stainless.com/) from
a specification of the turbopuffer API. This unlocks several benefits:

  * Improved ergonomics. The Stainless-generated clients have been carefully
    designed to follow language best practices.

  * Support for additional languages. Client libraries for
    [Go](https://github.com/turbopuffer/turbopuffer-go) and
    [Java](https://github.com/turbopuffer/turbopuffer-java) are already
    available. A client library for
    [Rust](https://github.com/turbopuffer/turbopuffer-rust) is expected by
    the end of 2025.

  * Faster releases. New API features will be available in all client libraries
    within a few days of their release.

There are several breaking changes as a result of this rewrite:

- Compression is not optimized for large responses.

  TODO(benesch): fix this.

- The following performance metrics have been removed without replacement:

  - `response_time`
  - `body_read_time`
  - `compress_time`
  - `deserialize_time`

  TODO(benesch): restore these?

- Several changes have been made to the `Turbopuffer` constructor:

  - A mandatory `region` parameter has been added. This is more convenient
    than passing the full base URL.

  - The `baseUrl` parameter has been renamed to `baseURL`. The base URL must
    be a fully-specified URL, including the protocol (e.g., `https://`).

  - The `apiKey` parameter defaults to the `TURBOPUFFER_API_KEY` environment
    variable.

  Old:

  ```ts
  const tpuf = new Turbopuffer({
    apiKey: process.env.TURBOPUFFER_API_KEY,
    region: 'https://gcp-us-central1.turbopuffer.com',
  });
  ```

  New:

  ```ts
  const tpuf = new Turbopuffer({
    // Use `region` instead of `baseUrl` if possible.
    region: 'gcp-us-central1',
    // No need to pass `apiKey` if using the `TURBOPUFFER_API_KEY` environment
    // variable.
  });
  ```

- The `updateSchema` method now takes a `schema` parameter instead of
  taking the schema directly.

  Old:

  ```ts
  await tpuf.namespace('ns').updateSchema({
    attr1: 'val1',
    attr2: 'val2',
    // ...
  });
  ```

  New:

  ```ts
  await tpuf.namespace('ns').updateSchema({
    schema: {
      attr1: 'val1',
      attr2: 'val2',
      // ...
    },
  });
  ```

- The `metadata` method has been removed.

  - To query for the number of documents in a namespace, use a `count` aggregate
    query instead.

    ```ts
    const results = await tpuf.namespace('ns').query({
      aggregate_by: { count: ['Count', 'id'] },
    });
    console.log(results.aggregations?.count);
    ```

  - To determine the dimensionality of the vectors in a namespace, use
    `getSchema` instead and inspect the type of the `vector` attribute.

  - There is no replacement for accessing the `created_at` field. [Contact us]
    if you need this field.

- The `export` method has been removed.

  Instead, use the `query` method to page through documents by advancing a
  filter on the `id` attribute.

  See <https://turbopuffer.com/docs/export> for sample code.

- The `rows` field returned by the `query` method is now nullable. Adjust your
  code to handle this appropriately (e.g., by using a non-null assertion or a
  null coalescing operator):

  Old:

  ```ts
  const results = await tpuf.namespace('ns').query({ top_k: 10 });
  const topDoc = results.rows[0];
  ```

  New:

  ```ts
  const results = await tpuf.namespace('ns').query({ top_k: 10 });
  const topDoc = results.rows![0]; // note non-null assertion
  ```

  The reason for this change is that queries that specify an `aggregate_by`
  parameter will return data in the `aggregations` field rather than the
  `rows` field.

- Error types have been refactored. The new types are reasonably self
  describing, but [contact us] if you need help.

[contact us]: https://turbopuffer.com/contact
